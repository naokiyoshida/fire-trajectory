# fire-trajectory (自由への軌道)

## 概要

fire-trajectoryは、あなたの資産形成の軌道を可視化し、FIRE（Financial Independence, Retire Early）への道のりを加速させるための、全自動資産データ収集・分析ツールキットです。

日々の資産管理に利用している「マネーフォワード ME」から取引履歴データを自動で取得し、Google スプレッドシートに蓄積。蓄積されたデータを基に、独自の二段構えシミュレーション（詳細キャッシュフロー表＆感度分析）を行うことで、精度の高い未来予測と戦略立案をサポートします。

## 主な特徴

- **全自動データ収集**: 面倒な手作業は一切不要。起動用HTMLファイルをクリックするだけで、複数ヶ月分の取引履歴データを自動で収集・整形し、Google スプレッドシートに転送します。
- **適応型同期 (Adaptive Sync)**: スプレッドシートが空か否かを自動で判定。初回は過去最大52ヶ月分のデータを取得し、2回目以降は差分として直近6ヶ月分のみを取得する効率的な同期を行います。
- **堅牢な実行環境**:
    - **Sandbox Bypass**: データ収集完了後、プロセスが実行されたタブは自動で閉じるため、余計な手作業は必要ありません。
    - **安定した待機処理**: ページの描画状態を正確に監視することで、通信環境に左右されず、確実なデータ取得を実現します。
    - **自動リトライ機能**: 一時的なネットワークエラーが発生しても、自動で数回再試行するため、同期の成功率が格段に向上しています。
- **柔軟な設定**: スクリプトのメニューから、いつでも接続先のURLなどを簡単に再設定できます。
- **高精度なFIREシミュレーション**: Google スプレッドシート上で、以下の二段構えのシミュレーションが可能です。
    - **詳細キャッシュフロー表**: 収集したデータを基に、将来の資産推移を詳細にシミュレーションします。
    - **感度分析**: 利率や積立額など、複数の変数を同時に変動させ、資産推移への影響度合いを分析（モンテカルロ法など）できます。

## アーキテクチャ

本プロジェクトは、以下のコンポーネントが連携して動作します。

```text
        +--------+     1. 起動         +--------------------+     2. 新規タブで開く      +---------------------------+
        |  User  |------------------>| fire-launcher.html |------------------------>| Money Forward ME (CFページ) |
        +--------+                   +--------------------+                         +---------------------------+
                                                                                                |
                                                                            3. 'mf_sync_client.user.js'
                                                                               (Tampermonkey) が自動実行
                                                                                                |
                                                                                (ページ内を自動で遷移・データ収集)
                                                                                                |
    +-------------------------------------------------------------------------------------------+
    |   4. 収集したデータを送信 (HTTPS POST)                                                    |
    |                                                                                           |
    v                                                                                           |
    +------------------------+      5. データを受信・処理      +-------------------------------+
    | 'gas_receiver_service.gs'|---------------------------->|  Google Spreadsheet (Database)  |
    | (Google Apps Script)   |      (重複チェック・追記)     +-------------------------------+
    +------------------------+                                                ^
                                                                              |
                                                       6. ユーザーがスプレッドシート上で
                                                          シミュレーションを実行・分析
                                                                              |
                                                                        +--------+
                                                                        |  User  |
                                                                        +--------+
```

## セットアップ

本システムを利用するには、サーバーサイド(Google Apps Script)とクライアントサイド(Tampermonkey)の両方を設定する必要があります。

### 1. Google Apps Script (GAS) の設定

1.  Google Driveで新規にGoogleスプレッドシートを作成し、任意の名前（例: fire-trajectory-database）をつけます。
2.  「拡張機能」メニューから「Apps Script」を選択し、GASエディタを開きます。
3.  `gas_receiver_service.gs` ファイルの中身をGASエディタにコピー＆ペーストします。
4.  GASエディタの左側にある「プロジェクトの設定」（歯車アイコン）を開き、「'appsscript.json' マニフェスト ファイルをエディタで表示する」にチェックを入れます。
5.  エディタに表示された `appsscript.json` を開き、内容を本プロジェクトの `appsscript.json` ファイルの中身で上書きします。
6.  GASエディタの「プロジェクトの設定」画面に戻り、「スクリプト プロパティ」のセクションで以下の2つのプロパティを追加します。
    - **API_KEY**: 外部からの不正なアクセスを防ぐための秘密の文字列。推測されにくい任意の文字列（例: `your-super-secret-key-12345`）を設定します。
    - **SHEET_NAME**: データを記録するシート名。デフォルトは 'Database' ですが、変更したい場合はここで設定します。（例: `TransactionData`）
7.  画面右上の「デプロイ」ボタンから「新しいデプロイ」を選択します。
8.  「種類の選択」で「ウェブアプリ」を選択し、以下の通り設定します。
    - **説明**: 任意（例: fire-trajectory receiver）
    - **次のユーザーとして実行**: 自分
    - **アクセスできるユーザー**: 全員
9.  「デプロイ」をクリックします。初回は承認が必要です。
10. 表示された**ウェブアプリのURL**をコピーします。これがクライアントの設定で必要になります。

### 2. Tampermonkey スクリプトの設定

1.  お使いのブラウザに、拡張機能「Tampermonkey」をインストールします。
2.  Tampermonkeyのダッシュボードを開き、「新規スクリプトを追加」タブに移動します。
3.  `mf_sync_client.user.js` ファイルの中身をエディタにコピー＆ペーストし、保存します。
4.  マネーフォワード ME のサイト（`https://moneyforward.com/cf`）にアクセスします。
5.  スクリプトが初回実行されると、GASのURLを尋ねるプロンプトが表示されます。先ほどコピーした**ウェブアプリのURL**を貼り付けてOKを押します。（もし認証を有効にする場合は、APIキーを尋ねるプロンプトも表示されます）
6.  設定は以上で完了です。設定値はTampermonkeyのメニューからいつでも再設定できます。

## 使い方

1.  ローカルに保存した `fire-launcher.html` ファイルをブラウザで開きます。
2.  「Sync Start」ボタンをクリックします。
3.  新しいタブでマネーフォワード MEが開き、データ同期プロセスが自動で開始されます。
4.  処理が完了すると、タブは自動で閉じられます。
5.  Google スプレッドシートを開き、データが正しく記録されていることを確認してください。

## ライセンス

This project is licensed under the MIT License.
