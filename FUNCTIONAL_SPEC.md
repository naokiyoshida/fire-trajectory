# 機能仕様書: fire-trajectory

- プロジェクト名: fire-trajectory (自由への軌道)
- バージョン: 1.1
- 作成者: 吉田直樹
- 最終更新日: 2026/01/31

---

## 1. はじめに

本文書は、資産寿命シミュレーター『fire-trajectory』の機能仕様、計算論理、および技術的実装の詳細について定義するものである。

## 2. システム概要

本システムは、クライアントサイドのユーザースクリプトと GAS が連携し、マネーフォワード ME から取得した取引履歴を Google スプレッドシートに蓄積・分析するものである。

### 2.1. アルゴリズム・アーキテクチャ

1. **起動**: `RunSyncHidden.ps1` (PowerShell) が Chrome をバックグラウンドで起動。
2. **収集**: `mf_sync_client.user.js` (Tampermonkey) が CF ページでデータをスクレイピング。
3. **送信**: データを HTTPS POST で GAS へ送信。
4. **受信**: `gas_receiver_service.gs` が重複を排除して `Database` シートに追記。
5. **分析**: 蓄積データに基づき、`Simulation` シートで将来予測を実行。

## 3. データ同期仕様 (Adaptive Sync)

### 3.1. 同期戦略

スプレッドシートの状態に応じて同期期間を自動で変更する。

- **Full Mode**:
  - 条件: `Database` シートが空、またはヘッダーのみ。
  - 動作: 2021年10月まで遡り、全データを取得。
- **Incremental Mode**:
  - 条件: データが1行以上存在。
  - 動作: 直近6ヶ月分のデータを取得し、差分を更新。

### 3.2. 通信スキーマ (JSON)

- **Action**: `get_sync_config` / `sync_data`
- **Auth**: APIキーによる簡易認証に対応。

## 4. シミュレーション計算論理

### 4.1. 実質利回りの算出 (フィッシャー方程式)

インフレ調整後の成長率を月次複利として適用する。

- **年間実質利回り r**: $r = ((1 + n) / (1 + i)) - 1$
  - $n$: 名目利回り (Dashboard!B7), $i$: インフレ率 (Dashboard!B8)
- **月次実質利回り r_m**: $r_m = (1 + r)^{(1/12)} - 1$
- **資産更新式**: $P_t = (P_{t-1} + CF_t) * (1 + r_m)$
  - $P_t$: 期末資産, $CF_t$: 月次キャッシュフロー

### 4.2. ライフイベント制御

`Dashboard` シートの設定値に基づき、キャッシュフローを動的に切り替える。

- **収入 (Income)**:
  - **本人給与**: リタイア予定日 (`Dashboard!B5`) まで加算。
  - **配偶者給与**: 配偶者退職予定日 (`Dashboard!B16`) まで加算 (年額/12)。
  - **年金**: 65歳到達月 (誕生日+65年) 以降、本人 (`Dashboard!B11`) および配偶者 (`Dashboard!B12`) の年金を加算 (年額/12)。
  - **退職一時金**: 配偶者退職月に一時金 (`Dashboard!B17`) を加算。
- **支出 (Expense)**:
  - **基本生活費**: ベースとなる月額支出 (`Dashboard!B6`)。
  - **住宅ローン**: 完済予定日 (`Dashboard!B9`) まで月額 (`Dashboard!B10`) を加算。
  - **息子支援**: 支援終了日 (`Dashboard!B13`) まで月額 (`Dashboard!B14`) を加算。

### 4.3. 自動セットアップ機能

GAS の `setupSimulation()` 関数により、以下の環境を自動構築する。

- **Dashboard シート**: シミュレーションの全パラメータを管理するコントロールパネル。
  - **カラム構成**:
    - **A列**: 設定項目名
    - **B列**: **設定値** (ユーザーが編集する値。シミュレーション計算に使用)
    - **C列**: 説明
    - **D列**: **デフォルト値** (参考用。初期設定値が表示される)
  - **設定値の保持**: `setupSimulation` を再実行しても、B列に入力済みの値は保持され、クリアされずに引き継がれる。
- **Simulation シート**: 30年分（360行）の数式モデルと、資産推移を描画するエリアチャートの自動生成。

## 5. セキュリティ・自動化

### 5.1. Sandbox Bypass

`window.opener` を利用することで、セキュリティ制限を回避しながらデータ同期完了後にタブを自動で閉じる（`window.close()`）。

### 5.2. Stealth Execution

PowerShell の `-WindowStyle Minimized` と `chrome --headless=new` (オプション) を組み合わせることで、PC作業を妨げないバックグラウンド自動実行を実現する。
