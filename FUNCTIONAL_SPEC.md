# 機能仕様書 (FUNCTIONAL_SPEC)

## 1. 概要

本システムは、資産形成の現状把握（Sync）と将来予測（Simulation）を統合したファイナンシャル・プランニング支援システムである。

## 2. 前提条件 (Project Context)

- **対象ユーザー**: 開発者本人
- **生年月日**: 1977/03/09
- **重要ライフイベント**:
  - **教育費/ローン支援終了**: 2028/03/31

## 3. 計算論理 (Calculation Logic)

### 実質利回り (Real Yield)

将来価値の算出には、インフレーション調整後の「実質利回り」を使用する。フィッシャー方程式に基づき、名目利回り($n$)とインフレ率($i$)から実質利回り($r$)を算出する。

$$
r = \frac{1+n}{1+i} - 1
$$

この $r$ を月次複利として適用し、各月の資産残高を予測する。

## 4. 同期戦略 (Sync Strategy)

### Adaptive Sync (適応型同期)

データ量と運用フェーズに応じて、同期範囲を動的に決定する。GAS側(`gas_receiver_service.gs`)で最終行判定を行い、クライアントへモード指示 (`mode`) を返却する。

1. **Full Mode**:
    - 条件: シートのデータ行が1行以下（新規または初期化直後）。
    - 動作: 2021年10月（システム運用開始基準月）まで遡り、全データを同期する。
2. **Incremental Mode**:
    - 条件: 既にデータが存在する。
    - 動作: 直近6ヶ月（`INCREMENTAL_MONTHS`設定値）分のデータのみを同期し、差分更新を行う。

## 5. データ構造 (Data Structure)

### Database シート

Money Forward ME から収集したトランザクションデータを蓄積する。

| カラム名 | キー (Internal) | 説明 |
|---|---|---|
| ID | `ID` | `SHA256(日付+内容+金額+金融機関+大中項目)` で生成される一意なハッシュキー |
| 日付 | `date` | 取引日 (YYYY/MM/DD) |
| 内容 | `content` | 取引内容・摘要 |
| 金額 | `amount` | 取引金額（円、カンマなし） |
| 保有金融機関 | `source` | 出金元/入金先の金融機関名 |
| 大項目/中項目 | `category` | カテゴリ ("食費/食料品" 等) |
| 取得日時 | `sync_timestamp` | GASがデータを受信したサーバー時刻 |

## 6. イベント制御 (Event Control)

シミュレーションにおいて、以下の時点をフラグとしてキャッシュフロー計算ロジックを切り替える（スプレッドシート上の数式ロジックとして実装）。

- **教育費・ローン完済**: 2028年4月以降、関連する固定費支出をゼロとして扱う。
- **配偶者退職**: 配偶者の年齢到達に基づき、給与収入を停止する。
- **年金受給開始**: 65歳到達月より、公的年金収入をキャッシュフローに加算する。

## 7. 通信仕様 (Communication Spec)

クライアント(Tampermonkey)からGASへのデータ送信は `POST` メソッドで行う。

### Request (JSON)

```json
{
  "action": "sync_data",  // または "get_sync_config"
  "apiKey": "（オプション: APIキー）",
  "data": [
    {
      "ID": "hash_value...",
      "date": "2026/01/01",
      "content": "コンビニ決済",
      "amount": "500",
      "source": "財布",
      "category": "食費"
    }
  ]
}
```

## 8. セキュリティ・自動化 (Automation & Security)

### Sandbox Bypass

ブラウザのセキュリティ制約内での自動化を実現するため、以下の機構を採用する。

- **自動クローズ**: `window.close()` を利用し、処理完了後にタブを自動的に閉じる（設定により待機時間調整可）。
- **Headless Mode**: PowerShellスクリプト(`RunSyncHidden.ps1`)により、Chromeを専用プロファイルかつウィンドウ非表示（Hidden/Minimized）状態で起動し、作業を妨げないバックグラウンド実行を保証する。
