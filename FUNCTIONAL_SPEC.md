# 機能仕様書: fire-trajectory

- プロジェクト名: fire-trajectory (自由への軌道)
- バージョン: 1.1
- 作成者: 吉田直樹
- 最終更新日: 2026/01/31

---

## 1. はじめに

本文書は、資産寿命シミュレーター『fire-trajectory』の機能仕様、計算論理、および技術的実装の詳細について定義するものである。

## 2. システム概要

本システムは、クライアントサイドのユーザースクリプトと GAS が連携し、マネーフォワード ME から取得した取引履歴を Google スプレッドシートに蓄積・分析するものである。

### 2.1. アルゴリズム・アーキテクチャ

1. **起動**: `RunSyncHidden.ps1` (PowerShell) が Chrome をバックグラウンドで起動。
2. **収集**: `mf_sync_client.user.js` (Tampermonkey) が CF ページでデータをスクレイピング。
3. **送信**: データを HTTPS POST で GAS へ送信。
4. **受信**: `gas_receiver_service.gs` が重複を排除して `Database` シートに追記。
5. **分析**: 蓄積データに基づき、`Simulation` シートで将来予測を実行。

## 3. データ同期仕様 (Adaptive Sync)

### 3.1. 同期戦略

スプレッドシートの状態に応じて同期期間を自動で変更する。

- **Full Mode**:
  - 条件: `Database` シートが空、またはヘッダーのみ。
  - 動作: 2021年10月まで遡り、全データを取得。
- **Incremental Mode**:
  - 条件: データが1行以上存在。
  - 動作: 直近6ヶ月分のデータを取得し、差分を更新。

### 3.2. 通信スキーマ (JSON)

- **Action**: `get_sync_config` / `sync_data`
- **Auth**: APIキーによる簡易認証に対応。

## 4. シミュレーション計算論理

### 4.1. 実質利回りの算出 (フィッシャー方程式)

インフレ調整後の成長率を月次複利として適用する。

- **年間実質利回り r**: $r = ((1 + n) / (1 + i)) - 1$
  - $n$: 名目利回り, $i$: インフレ率
- **月次実質利回り r_m**: $r_m = (1 + r)^{(1/12)} - 1$
- **資産更新式**: $P_t = (P_{t-1} + CF_t) * (1 + r_m)$
  - $P_t$: 期末資産, $CF_t$: 月次キャッシュフロー

### 4.2. ライフイベント制御

以下の特定イベントをトリガーに、キャッシュフローを動的に切り替える。

- **息子支援終了**: 2028/03/31以降、関連支出をゼロに設定。
- **住宅ローン完済**: 設定年月以降、返済額を除外。
- **年金受給開始**: 満65歳到達（1977/03/09 + 65年）の翌月より収入に加算。

### 4.3. 自動セットアップ機能

GAS の `setupSimulation()` 関数により、以下の環境を自動構築する。

- **Settings シート**: 利回り、インフレ率、初期資産、イベント日付等のパラメータ一括管理。
- **Simulation シート**: 30年分（360行）の数式モデルと、資産推移を描画するエリアチャートの自動生成。

## 5. セキュリティ・自動化

### 5.1. Sandbox Bypass

`window.opener` を利用することで、セキュリティ制限を回避しながらデータ同期完了後にタブを自動で閉じる（`window.close()`）。

### 5.2. Stealth Execution

PowerShell の `-WindowStyle Minimized` と `chrome --headless=new` (オプション) を組み合わせることで、PC作業を妨げないバックグラウンド自動実行を実現する。
