# 機能仕様書: fire-trajectory (FUNCTIONAL_SPEC)

## 1. システム概要
本ドキュメントは、マネーフォワードMEの実績データを基にした資産寿命シミュレーター「fire-trajectory」の技術的仕様、計算アルゴリズム、およびデータ構造を定義するものである。

開発者：吉田直樹 (1977/03/09生)

## 2. 資産演算ロジック

### 2.1 実質利回りの定義
将来の資産価値を現在の購買力で評価するため、名目利回りから想定インフレ率を控除した「実質利回り」をフィッシャー方程式に基づき算出する。

計算式（月次実質利回り）:
r_real = ((1 + nominal_rate) / (1 + inflation_rate)) ^ (1/12) - 1

### 2.2 資産残高の再帰計算
毎月の資産推移は、前月末の残高に対して当月のキャッシュフローを加減算したのち、実質利回りを乗じて算出する。

計算式:
Assets(t) = (Assets(t-1) + Net_CashFlow(t)) * (1 + r_real)

## 3. 同期戦略 (Adaptive Sync)

### 3.1 同期モードの自動判定
GAS側で受信時、SpreadsheetApp.getLastRow() を用いてDatabaseシートの状態を確認し、同期期間を決定する。

判定アルゴリズム:
- IF getLastRow <= 1 (ヘッダーのみ)
  THEN Mode = Full (2021/10/01 から現在までの約52ヶ月分を同期)
- ELSE
  THEN Mode = Incremental (直近6ヶ月分を同期し、既存行を上書き更新)

### 3.2 秘匿情報の管理 (Secret Separation)
GASのエンドポイントURLは、Git管理対象外の src/fire-config.js に外部化する。
UserScript実行時に @require 経由でローカル絶対パスから読み込むことで、セキュリティと利便性を両立する。

## 4. データ構造定義

### 4.1 Databaseシート (明細データ)
1. 日付 (yyyy/MM/dd)
2. 内容 (店舗・摘要)
3. 金額 (数値型、カンマ/円記号除去済み)
4. 保有金融機関
5. カテゴリー

### 4.2 Dashboardシート (シミュレーション結果)
- F列-H列: 詳細推移（指定したリタイア予定日に基づく月次推移）
- J列-M列: 感度分析（リタイア年齢 50歳〜75歳 変化時の資産尽き年齢一覧）

## 5. ライフイベント制御ロジック

### 5.1 支出・支援イベント
- 息子支援金 (-50,000 JPY): 2028/03/31（支援終了日）まで毎月計上。
- 住宅ローン返済: 設定された完済予定月まで毎月計上。

### 5.2 収入・年金イベント
- 配偶者収入: 配偶者退職予定日まで計上。
- 本人公的年金: 本人生年月日 (1977/03/09) に基づき、65歳到達月 (2042/03) より計上開始。

## 6. 通信・インターフェース仕様

### 6.1 リクエストスキーマ (JSON)
TampermonkeyからGASへの送信データは以下の形式とする。

{
  "action": "sync_data",
  "data": [
    {
      "date": "2026/01/01",
      "content": "XXXスーパー",
      "amount": -3500,
      "source": "XXX銀行",
      "category": "食費"
    },
    ...
  ]
}

### 6.2 Sandbox Bypass (自動終了処理)
ブラウザのセキュリティ制限（Sandbox）を回避するため、以下の親子関係を利用して自動タブクローズを実現する。

1. fire-launcher.html が window.open() を発行（親ウィンドウ）。
2. 子ウィンドウ（MFページ）上で UserScript が動作。
3. 処理完了後、UserScript が window.close() を発行。
4. スクリプトによって開かれたウィンドウであるため、ブラウザによりクローズが許可される。

---
最終更新: 2026-01-01 / 承認: 吉田直樹