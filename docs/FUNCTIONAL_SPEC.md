# 機能仕様書: fire-trajectory

- プロジェクト名: fire-trajectory (自由への軌道)
- バージョン: 1.0
- 作成者: 吉田直樹
- 最終更新日: 2026/01/02

---

## 1. はじめに

本文書は、資産寿命シミュレーター『fire-trajectory』の機能仕様、計算論理、および技術的実装の詳細について定義するものである。プロジェクトの保守性、拡張性を確保し、関係者間の共通理解を形成することを目的とする。

## 2. システム概要

本システムは、クライアントサイドで動作するユーザースクリプトと、サーバーサイドで動作するGoogle Apps Script (GAS) が連携し、金融口座アグリゲーションサービス「マネーフォワード ME」から取得した取引履歴をGoogle スプレッドシートに蓄積・分析するものである。

### 2.1. アーキテクチャ図

```text
        +--------+     1. 起動         +--------------------+     2. 新規タブで開く      +---------------------------+
        |  User  |------------------>| fire-launcher.html |------------------------>| Money Forward ME (CFページ) |
        +--------+                   +--------------------+                         +---------------------------+
                                                                                                |
                                                                            3. 'mf_sync_client.user.js'
                                                                               (Tampermonkey) が自動実行
                                                                                                |
                                                                                (ページ内を自動で遷移・データ収集)
                                                                                                |
    +-------------------------------------------------------------------------------------------+
    |   4. 収集したデータを送信 (HTTPS POST)                                                    |
    |                                                                                           |
    v                                                                                           |
    +------------------------+      5. データを受信・処理      +-------------------------------+
    | 'gas_receiver_service.gs'|---------------------------->|  Google Spreadsheet (Database)  |
    | (Google Apps Script)   |      (重複チェック・追記)     +-------------------------------+
    +------------------------+
```

## 3. データ同期仕様

### 3.1. 同期戦略: Adaptive Sync

2回目以降のデータ取得処理を高速化するため、スプレッドシートの状態に応じて同期期間を自動で変更する適応型同期（Adaptive Sync）戦略を採用する。

- **目的**: 不要なデータ取得を避け、API負荷と処理時間を最小化する。
- **実装箇所**: 'gas_receiver_service.gs' 内の 'handleSyncConfig' 関数。
- **判定ロジック**: 'SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME).getLastRow()' メソッドの返り値を利用する。
- **判定フロー**:
    - getLastRow() の結果が 1 以下（ヘッダー行のみ、または空）の場合:
        - 同期モードとして 'Full' をクライアントに返却する。
        - クライアントは過去52ヶ月分のデータを取得する。
    - getLastRow() の結果が 2 以上（データ行が1行以上存在する）の場合:
        - 同期モードとして 'Incremental' をクライアントに返却する。
        - クライアントは過去6ヶ月分のデータを取得する。

### 3.2. 通信仕様

クライアント('mf_sync_client.user.js')からサーバー('gas_receiver_service.gs')への通信は、HTTPS POSTリクエストにて行われる。リクエストボディはJSON形式とする。

**エンドポイントURL**: (ユーザーがGASデプロイ時に取得するURL)

**リクエスト種別 1: 同期設定取得**
- **Action**: get_sync_config
- **Request Body (JSON Schema)**:
    ```json
    {
        "action": "get_sync_config",
        "apiKey": "(string) 認証用APIキー"
    }
    ```
- **Response Body (JSON Schema)**:
    ```json
    {
        "status": "(string) 'success' or 'error'",
        "mode": "(string) 'Full' or 'Incremental'",
        "message": "(string, optional) エラー時にメッセージを格納"
    }
    ```

**リクエスト種別 2: データ同期**
- **Action**: sync_data
- **Request Body (JSON Schema)**:
    ```json
    {
        "action": "sync_data",
        "apiKey": "(string) 認証用APIキー",
        "data": [
            {
                "id": "(string) トランザクションのハッシュID",
                "date": "(string) YYYY/MM/DD",
                "content": "(string) 内容",
                "amount": "(string) 金額(円, カンマなし)",
                "source": "(string) 金融機関",
                "category": "(string) 大分類"
            },
        ]
    }
    ```
- **Response Body (JSON Schema)**:
    ```json
    {
        "status": "(string) 'success' or 'error'",
        "count": "(number) 追加されたレコード数",
        "message": "(string, optional) エラー時にメッセージを格納"
    }
    ```

### 3.3. セキュリティ回避: Sandbox Bypass (自動クローズ)

近年のブラウザは、スクリプトによるウィンドウの自動クローズ('window.close()')に対して厳しいセキュリティ制限を課している。本システムでは、'window.opener' を利用することでこの制限を回避し、UXを向上させる。

- **目的**: データ同期完了後、ユーザーの手を煩わせることなく、自動でタブを閉じる。
- **技術的背景**: スクリプトによって能動的に開かれたウィンドウ（'window.open()'の返り値）のみ、そのスクリプトから 'window.close()' で閉じることが許可されている。
- **実装**:
    1.  ユーザーは 'fire-launcher.html' を起点として操作を開始する。
    2.  'fire-launcher.html' 内のスクリプトが 'window.open()' を用いてマネーフォワードMEのCFページを新しいタブで開く。
    3.  これにより、新しく開かれたタブの 'window.opener' プロパティが 'fire-launcher.html' のウィンドウを指し示す状態となる。
    4.  データ同期が完了した 'mf_sync_client.user.js' は 'window.close()' を呼び出す。ブラウザは 'opener' が存在することを認識し、この操作を許可する。

## 4. データ構造仕様

### 4.1. Google スプレッドシート: 'Database' シート

収集された全取引履歴は、指定されたGoogleスプレッドシート内の 'Database' (またはユーザーがプロパティで指定した名前)シートに時系列で記録される。

- **カラム定義**:
    +----------+------------------+--------------------------------------+
    | 列名     | データ型         | 説明                                 |
    +----------+------------------+--------------------------------------+
    | id       | String           | トランザクションの一意なハッシュID   |
    | date     | String (Text)    | 取引日 (YYYY/MM/DD形式)              |
    | content  | String (Text)    | 取引内容                             |
    | amount   | Number           | 金額 (円、カンマなし、支出はマイナス)|
    | source   | String (Text)    | 金融機関名                           |
    | category | String (Text)    | 大分類                               |
    | sync_ts  | Datetime         | このレコードが同期された日時         |
    +----------+------------------+--------------------------------------+

## 5. シミュレーション計算論理

スプレッドシート上で実行される資産寿命シミュレーションの計算論理を定義する。

### 5.1. 実質利回りの算出と適用 (フィッシャー方程式)

インフレ（物価上昇）の影響を差し引いた、より現実的な資産の成長率を計算するため、フィッシャー方程式に基づく実質利回りを採用する。

- **定義**:
    - n: 名目利回り (年間)。ユーザーが設定する期待運用利回り。
    - i: インフレ率 (年間)。ユーザーが設定する想定インフレ率。
    - r: 実質利回り (年間)。
- **計算式**:
    - 年間実質利回り r = ( (1 + n) / (1 + i) ) - 1
- **月次適用ロジック**:
    - シミュレーションは月次で行うため、年間実質利回り r を月次実質利回り r_m に変換する。
        - 月次実質利回り r_m = (1 + r)^(1/12) - 1
    - 各月のシミュレーションにおける期末資産 P_t は、期首資産 P_{t-1} と当該月のキャッシュフロー(収入-支出) CF_t を用いて、以下の式で計算される。
        - P_t = (P_{t-1} + CF_t) * (1 + r_m)

### 5.2. ライフイベント制御

シミュレーション期間中に発生する、キャッシュフローに大きな変動をもたらすライフイベントをモデルに組み込む。イベント発生は、シミュレーション上の現在日付が、事前に定義されたイベント発生日を越えたか否かで判定する。

- **イベント1: 年金受給開始**
    - **トリガー**: 開発者本人（吉田直樹）が満65歳に達する月の翌月から。
    - **判定**:
        - 本人誕生日: 1977/03/09
        - 年金開始基準日: 2042/03/09 (誕生日 + 65年)
        - 制御ロジック: シミュレーション日付 > 2042/03/31 の場合、月次のキャッシュフローに想定年金受給額（ユーザー設定値）を加算する。

- **イベント2: 息子支援終了**
    - **トリガー**: 2028年3月31日をもって、息子への経済的支援が終了するものと仮定する。
    - **判定**:
        - 支援終了日: 2028/03/31
        - 制御ロジック: シミュレーション日付 > 2028/03/31 の場合、月次のキャッシュフローから息子支援関連の支出（ユーザー設定値）を除外する。

- **イベント3: 住宅ローン完済**
    - **トリガー**: ユーザーが設定するローン完済予定年月。
    - **判定**:
        - 制御ロジック: シミュレーション日付がローン完済年月を越えた場合、月次のキャッシュフローから住宅ローン返済額（ユーザー設定値）を除外する。

- **イベント4: 配偶者退職**
    - **トリガー**: ユーザーが設定する配偶者の退職予定年月。
    - **判定**:
        - 制御ロジック: シミュレーション日付が配偶者退職年月と一致する月に、退職金（ユーザー設定値）を収入として一度だけ加算する。
        - 加えて、その翌月以降、月次のキャッシュフローから配偶者の収入（ユーザー設定値）を除外する。
